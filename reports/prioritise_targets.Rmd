---
title: "prioritise_targets"
author: "<h4>Authors:</h4> Momoko Otani, Brian M. Schilder, Nathan G. Skene"
date: "<h4>Updated: <i>`r format( Sys.Date(), '%b-%d-%Y')`</i></h4>"
output:
  html_document
---

# Install packages

```{r, warning=FALSE, message=FALSE}
if(!require("htmltools")) install.packages("htmltools") 
if(!require("remotes")) install.packages("remotes") 
if(!require("MultiEWCE")) remotes::install_github("neurogenomics/MutltiEWCE", dependencies = TRUE)
```

# Prioritise targets

## Filter & sort

```{r} 
res <- MultiEWCE::prioritise_targets()
```


### Top targets 

Here are the top gene targets based on the default filtering/sorting criterion of `prioritise_targets`.

```{r}
MultiEWCE::create_dt(res$top_targets)
```

### Filtering report 

Here is a report that shows how many phenotypes/celltypes/genes remained
after each step within the `prioritise_targets` pipeline.

```{r}
MultiEWCE::create_dt(res$report)
```


## Plot network

Generate a network from the top phenotype-celltype-gene associations.

```{r, fig.height=20, results='asis'}
vn_top <- MultiEWCE::prioritise_targets_network(top_targets = res$top_targets, 
                                                 save_path = here::here("reports",
                                                            "top_targets_network.html"),
                                                show_plot = FALSE)
# visNetwork::renderVisNetwork(vn_top$plot)
```

```{r, results='asis'}
htmltools::includeHTML("https://github.com/neurogenomics/RareDiseasePrioritisation/raw/master/reports/top_targets_network.html")
```


### [Full screen version](https://neurogenomics.github.io/RareDiseasePrioritisation/reports/top_targets_network.html)


## Aggregate results

```{r}
df_agg <- MultiEWCE::agg_results(phenos = res$top_targets,
                                 count_var = "CellType", 
                                 group_var = c("Phenotype","ancestor_name"))

MultiEWCE::create_dt(df_agg)
```

### Aggregate results

Subset phenotypes to those included in intellectual disability, 
and are related to cognition.

```{r}
df_intel <- res$top_targets[
    disease_characteristic=="Intellectual disability" &
    (!Phenotype %in% c("Choreoathetosis","Coma")),]
```

### Top genes

```{r} 
top_genes <- sort(table(df_intel$Gene),
                  decreasing = TRUE)
print(top_genes)
```

### Top cell types

```{r} 
top_celltypes <- sort(table(unique(df_intel[,c("Phenotype","HPO_ID","CellType")])$CellType),
         decreasing = TRUE)
print(top_celltypes)
```

# Prioritise targets: extended

Now let's lift some of the filters on phenotypes and cell types
to recover a more extensive network.

## Filter & sort

```{r}
res_all <- MultiEWCE::prioritise_targets(keep_onsets = NULL,
                                         keep_tiers = NULL,
                                         pheno_frequency_threshold = c(10,NA),
                                         gene_frequency_threshold = c(10,NA),
                                         severity_threshold = NULL,
                                         keep_specificity_quantiles = seq(30,40),
                                         keep_mean_exp_quantiles = seq(30,40))
```

## Plot network

Note that we set `physics=FALSE` to reduce the computation that it takes to render the plot.

```{r, fig.height=20} 
vn_all <- MultiEWCE::prioritise_targets_network(top_targets = res_all$top_targets, 
                                                save_path = here::here("reports",
                                                            "all_targets_network.html"), 
                                                physics = FALSE,  
                                                show_plot = FALSE)
```

```{r, results='asis'}
htmltools::includeHTML("https://github.com/neurogenomics/RareDiseasePrioritisation/raw/master/reports/all_targets_network.html")
```

### [Full screen version](https://neurogenomics.github.io/RareDiseasePrioritisation/reports/all_targets_network.html)

## Aggregate results

```{r}
all_agg <- MultiEWCE::agg_results(phenos = res_all$top_targets,
                                  count_var = "CellType", 
                                  group_var = "Phenotype")

MultiEWCE::create_dt(all_agg) 
```

### Top phenotypes

Get the phenotypes that were enriched in the greatest number of cell types.

```{r}
#### All ontology level ####
head(sort(table(unique(res_all$top_targets[,c("Phenotype","CellType")])$Phenotype), 
          decreasing = TRUE))

#### Only lower ontology levels #####
all_targets <- HPOExplorer::add_ont_lvl(res_all$top_targets)
head(sort(table(unique(res_all$top_targets[ontLvl<=4,c("Phenotype","CellType")])$Phenotype), 
          decreasing = TRUE))
```


### Top cell types

Get the cell types that were enriched in the greatest number of unique phenotypes.

```{r}
head(sort(table(unique(res_all$top_targets[,c("Phenotype","CellType")])$CellType), 
          decreasing = TRUE))
```

### Top genes

Get the genes that were enriched in the greatest number of unique phenotypes.

```{r}
head(sort(table(unique(res_all$top_targets[,c("Phenotype","Gene")])$Gene), 
          decreasing = TRUE))
```

### Top ancestors

Get the most common ancestors in the results.

```{r}
ancestor_freq <- sort(table(res_all$top_targets$ancestor), decreasing = TRUE) |>
    data.table::data.table() |> 
    `colnames<-`(c("HPO_ID","freq"))
ancestor_freq$Phenotype <- HPOExplorer::harmonise_phenotypes(phenotypes = ancestor_freq$HPO_ID)

MultiEWCE::create_dt(ancestor_freq) 
```


# Session info

<details>
```{r}
utils::sessionInfo()
```
</details>
<hr>