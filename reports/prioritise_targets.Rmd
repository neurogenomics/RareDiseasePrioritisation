---
title: "prioritise_targets"
author: "<h4>Authors:</h4> Momoko Otani, Brian M. Schilder, Nathan G. Skene"
date: "<h4>Updated: <i>`r format( Sys.Date(), '%b-%d-%Y')`</i></h4>"
output:
  html_document
---

# Install packages

```{r, warning=FALSE, message=FALSE}
if(!require("htmltools")) install.packages("htmltools") 
if(!require("remotes")) install.packages("remotes") 
if(!require("MultiEWCE")) remotes::install_github("neurogenomics/MutltiEWCE", dependencies = TRUE)
```

# Prioritise targets

## Gather data

```{r}
results <- MultiEWCE::load_example_results()
ctd <- MultiEWCE::load_example_ctd()
```

## Run filtering/sorting procedure

### Top targets per cell type-phenotype association

```{r} 
top_targets <- MultiEWCE::prioritise_targets(results = results,
                                             ctd = ctd)
```

## Plot network

Generate a network from the top phenotype-celltype-gene associations.

```{r, fig.height=12, results='asis'}
vn_top <- MultiEWCE::prioritise_targets_network(top_targets = top_targets, 
                                                 save_path = here::here("reports",
                                                            "top_targets_network.html"),
                                                layout = "layout_with_mds",
                                                show_plot = FALSE)
# visNetwork::renderVisNetwork(vn_top$plot)
```

```{r, results='asis'}
htmltools::includeHTML("https://github.com/neurogenomics/RareDiseasePrioritisation/raw/master/reports/top_targets_network.html")
```


[Full screen version](https://neurogenomics.github.io/RareDiseasePrioritisation/reports/top_targets_network.html)


## Aggregate results

```{r}
df_agg <- MultiEWCE::agg_results(phenos = top_targets,
                                 count_var = "CellType", 
                                 group_var = "Phenotype")

MultiEWCE::create_dt(df_agg)
```

### Aggregate results from Intellectual Disability phenotypes

Subset phenotypes to those included in intellectual disability, 
and are related to cognition.

```{r}
df_intel <- top_targets[disease_characteristic=="Intellectual disability" &
                        (!Phenotype %in% c("Choreoathetosis","Coma")),]
```

### Top genes

```{r} 
top_genes <- sort(table(df_intel$Gene),
                  decreasing = TRUE)
print(top_genes)
```

### Top cell types

```{r} 
top_celltypes <- sort(table(unique(df_intel[,c("Phenotype","HPO_ID","CellType")])$CellType),
         decreasing = TRUE)
print(top_celltypes)
```

# Prioritise targets: extended

Now let's lift some of the filters on phenotypes and cell types
to recover a more extensive network.

## Run filtering/sorting procedure

```{r}
all_targets <- MultiEWCE::prioritise_targets(results = results,
                                             ctd = ctd,
                                             # keep_celltypes = NULL, 
                                             # keep_onsets = NULL,
                                             keep_tiers = NULL)
```

## Plot network

```{r} 
vn_all <- MultiEWCE::prioritise_targets_network(top_targets = all_targets, 
                                                save_path = here::here("reports",
                                                            "all_targets_network.html"), 
                                                show_plot = FALSE)
```

```{r, results='asis'}
htmltools::includeHTML("https://github.com/neurogenomics/RareDiseasePrioritisation/raw/master/reports/all_targets_network.html")
```

[Full screen version](https://neurogenomics.github.io/RareDiseasePrioritisation/reports/all_targets_network.html)

# Session info

<details>
```{r}
utils::sessionInfo()
```
</details>
<hr>