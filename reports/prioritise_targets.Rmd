---
title: "prioritise_targets"
author: "<h4>Authors:</h4> Momoko Otani, Brian M. Schilder, Nathan G. Skene"
date: "<h4>Updated: <i>`r format( Sys.Date(), '%b-%d-%Y')`</i></h4>"
output:
  html_document
runtime: shiny
---

# Install packages

```{r, warning=FALSE, message=FALSE}
if(!require("remotes")) install.packages("remotes") 
if(!require("MultiEWCE")) remotes::install_github("neurogenomics/MutltiEWCE")
```

# Prioritise targets

## Gather data

```{r}
results <- MultiEWCE::load_example_results()
ctd <- MultiEWCE::load_example_ctd()
```

## Run filtering/sorting procedure

### Top 3 targets per cell type-phenotype association

```{r} 
top_targets <- MultiEWCE::prioritise_targets(results = results,
                                             ctd = ctd,
                                             top_n = 3)
```

### All  cell type-phenotype associations that met criterion

```{r}
all_targets <- MultiEWCE::prioritise_targets(results = results,
                                             ctd = ctd, 
                                             top_n = NULL)
```

#### Aggregate results

```{r}
df_agg <- MultiEWCE::agg_results(phenos = all_targets,
                                 count_var = "CellType", 
                                 group_var = "Phenotype")

MultiEWCE::create_dt(df_agg)
```

## Aggregate results from Intellectual Disability phenotypes

Subset phenotypes to those included in intellectual disability, 
and are related to cognition.

```{r}
df_intel <- all_targets[disease_characteristic=="Intellectual disability" &
                        (!Phenotype %in% c("Choreoathetosis","Coma")),]
```

### Top genes

```{r} 
top_genes <- sort(table(df_intel$Gene),
                  decreasing = TRUE)
print(top_genes)
```

### Top cell types

```{r} 
top_celltypes <- sort(table(unique(df_intel[,c("Phenotype","HPO_ID","CellType")])$CellType),
         decreasing = TRUE)
print(top_celltypes)
```

# Plot targets

## Network

Generate a network from the top phenotype-celltype-gene associations.

```{r, fig.height=12}
vn <- MultiEWCE::prioritise_targets_network(top_targets = top_targets, 
                                            save_path = "targets_network.html",
                                            show_plot = FALSE)
visNetwork::renderVisNetwork(vn$plot)
```


# Session info

<details>
```{r}
utils::sessionInfo()
```
</details>
<hr>