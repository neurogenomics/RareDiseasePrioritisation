---
title: "Rare Disease Celltyping"
subtitle: "Prioritised Targets Network"
author: "<h4>Authors:</h4> Brian M. Schilder, Momoko Otani, Nathan G. Skene"
date: "<h4>Updated: <i>`r format( Sys.Date(), '%b-%d-%Y')`</i></h4>"
output:
  prettydoc::html_pretty: 
    theme: hpstr
    toc: true
    highlight: github
---

# Install packages

```{r, warning=FALSE, message=FALSE}
if(!require("htmltools")) install.packages("htmltools") 
if(!require("remotes")) install.packages("remotes") 
if(!require("MultiEWCE")) remotes::install_github("neurogenomics/MutltiEWCE", dependencies = TRUE)
```

# Prioritise targets

## Filter & sort

```{r} 
res <- MultiEWCE::prioritise_targets()
```

### Top targets 

Here are the top gene targets based on the default filtering/sorting criterion of `prioritise_targets`.

```{r}
MultiEWCE::create_dt(res$top_targets)
```

### Filtering report 

Here is a report that shows how many phenotypes/celltypes/genes remained
after each step within the `prioritise_targets` pipeline.

```{r}
MultiEWCE::create_dt(res$report)
```


## Plot network

Generate a network from the top phenotype-celltype-gene associations.

```{r, fig.height=50, results='asis'}
vn_top <- MultiEWCE::prioritise_targets_network(
    top_targets = res$top_targets,
    mediator_var = list(),
    save_path = here::here("reports","top_targets_network.html"), 
    show_plot = FALSE)

# visNetwork::visExport(vn_top$plot, type = "pdf", loadDependencies = T)
# visNetwork::renderVisNetwork(vn_top$plot)
# pagedown::chrome_print(input = here::here("reports","top_targets_network.html"),
#                        output = here::here("reports","top_targets_network.pdf"),
#                        format = "pdf")
# webshot::webshot(here::here("reports","top_targets_network.html"), 
#                  zoom = 1, 
#                  vwidth = 2000,
#                  vheight = 1000,
#                  file = path.expand("~/Downloads/ex.pdf"))

```

```{r, results='asis'}
htmltools::includeHTML("https://github.com/neurogenomics/RareDiseasePrioritisation/raw/master/reports/top_targets_network.html")
```


### [Full screen version](https://neurogenomics.github.io/RareDiseasePrioritisation/reports/top_targets_network.html)

## Aggregate results

### By phenotype

```{r}
df_agg <- MultiEWCE::agg_results(
    phenos = res$top_targets,
    count_var = "CellType", 
    group_var = c("Phenotype","ontLvl",
                  "tier","tier_auto",
                  "ancestor","ancestor_name",
                  "disease_characteristic","DiseaseNames",
                  "Onset","Onset_earliest","Onset_score_mean","Onset_score_min",
                  "pheno_freq_mean","pheno_freq_min",
                  "Severity_score_mean","Severity_score_min")
    )

MultiEWCE::create_dt(df_agg)
```

### By ancestor_name

```{r}
df_agg_ancestors <- MultiEWCE::agg_results(
    phenos = res$top_targets,
    count_var = "Phenotype", 
    group_var = "ancestor_name")

MultiEWCE::create_dt(df_agg_ancestors)
```

### Abnormality of the nervous system 

```{r}
nervous_system <- HPOExplorer::add_ancestor(
    phenos = res$top_targets[ancestor_name=="Abnormality of the nervous system",][,-c("ancestor","ancestor_name")],
                                      lvl = 5)
```


#### Cognitive

Subset phenotypes to those included in intellectual disability, 
and are related to cognition.

```{r} 
df_cog <- nervous_system[
    ancestor_name %in% c("Neurodevelopmental abnormality","Abnormality of higher mental function"),]
sort(unique(df_cog$Phenotype))

# df_cog_phenos <- dplyr::group_by(df_cog, ancestor_name) |> dplyr::summarise(phenos=unique(Phenotype))
```

##### Top genes

```{r} 
sort(table(df_cog$Gene), decreasing = TRUE)
```

##### Top cell types

```{r} 
sort(table(unique(df_cog[,c("Phenotype","HPO_ID","CellType")])$CellType),
         decreasing = TRUE)
```


#### Non-cognitive

```{r}
df_noncog <- nervous_system[!ancestor_name %in% unique(df_cog$ancestor_name),]
# unique(df_noncog$ancestor_name)

sort(unique(df_noncog$Phenotype))
```

##### Morphological central nervous system abnormality

```{r}
df_morpho <- df_noncog[ancestor_name=="Morphological central nervous system abnormality"]

unique(df_morpho$Phenotype)
```


### Abnormality of the musculoskeletal system

```{r}
musculoskeletal_system <- HPOExplorer::add_ancestor(
    phenos = res$top_targets[ancestor_name=="Abnormality of the musculoskeletal system",][,-c("ancestor","ancestor_name")],
                                      lvl = 5)

unique(musculoskeletal_system$Phenotype)
```



# Prioritise targets: extended

Now let's lift some of the filters on phenotypes and cell types
to recover a more extensive network.

## Filter & sort

```{r}
res_all <- MultiEWCE::prioritise_targets(keep_onsets = NULL,
                                         keep_tiers = NULL,
                                         severity_threshold = NULL,
                                         pheno_frequency_threshold = c(10,NA),
                                         gene_frequency_threshold = c(10,NA),
                                         keep_specificity_quantiles = seq(30,40),
                                         keep_mean_exp_quantiles = seq(30,40))
```


## Plot network


```{r, fig.height=50} 
vn_all <- MultiEWCE::prioritise_targets_network(top_targets = res_all$top_targets, 
                                                save_path = here::here("reports",
                                                            "all_targets_network.html"), 
                                                mediator_var = list(),
                                                show_plot = FALSE)
```

```{r, results='asis'}
htmltools::includeHTML("https://github.com/neurogenomics/RareDiseasePrioritisation/raw/master/reports/all_targets_network.html")
```

### [Full screen version](https://neurogenomics.github.io/RareDiseasePrioritisation/reports/all_targets_network.html)

## Aggregate results

```{r}
all_agg <- MultiEWCE::agg_results(phenos = res_all$top_targets,
                                  count_var = "CellType", 
                                  group_var = "Phenotype")

MultiEWCE::create_dt(all_agg) 
```

### Top phenotypes

Get the phenotypes that were enriched in the greatest number of cell types.

```{r}
#### All ontology level ####
head(sort(table(unique(res_all$top_targets[,c("Phenotype","CellType")])$Phenotype), 
          decreasing = TRUE))

#### Only lower ontology levels #####
all_targets <- HPOExplorer::add_ont_lvl(res_all$top_targets)
head(sort(table(unique(res_all$top_targets[ontLvl<=4,c("Phenotype","CellType")])$Phenotype), 
          decreasing = TRUE))
```


### Top cell types

Get the cell types that were enriched in the greatest number of unique phenotypes.

```{r}
head(sort(table(unique(res_all$top_targets[,c("Phenotype","CellType")])$CellType), 
          decreasing = TRUE))
```

### Top genes

Get the genes that were enriched in the greatest number of unique phenotypes.

```{r}
head(sort(table(unique(res_all$top_targets[,c("Phenotype","Gene")])$Gene), 
          decreasing = TRUE))
```

### Top ancestors

Get the most common ancestors in the results.

```{r}
ancestor_freq <- sort(table(res_all$top_targets$ancestor), decreasing = TRUE) |>
    data.table::data.table() |> 
    `colnames<-`(c("HPO_ID","freq"))
ancestor_freq$Phenotype <- HPOExplorer::harmonise_phenotypes(phenotypes = ancestor_freq$HPO_ID)

MultiEWCE::create_dt(ancestor_freq) 
```

# Manual queries

Get all results. 

```{r}
res_all <- MultiEWCE::prioritise_targets(keep_onsets = NULL,
                                         keep_tiers = NULL,
                                         severity_threshold = NULL,
                                         pheno_frequency_threshold = NULL,
                                         gene_frequency_threshold = NULL,
                                         keep_specificity_quantiles = NULL,
                                         keep_mean_exp_quantiles = NULL)
```


## Mental deterioration

Definition of "Mental deterioration" from the [HPO](https://hpo.jax.org/app/browse/term/HP:0001268):
> Loss of previously present mental abilities, generally in adults.
> Synonyms:    Cognitive decline, Cognitive decline, progressive, Intellectual deterioration, Mental deterioration, Progressive cognitive decline

Not included in `prioritise_targets` outputs by default because: 
    - "specificity_quantile" (median=6) and "mean_exp_quantile" (median=6) are quite low for most genes associated with "Mental deterioration"

```{r}  
md_targets <- res_all$top_targets[Phenotype=="Mental deterioration" & q<=0.05] 

sort(table(md_targets[CellType %in% c("Amacrine cells","Ganglion cells")]$Gene), 
     decreasing = TRUE)
```

## Recurrent Neisserial infections

```{r}
results <- MultiEWCE::load_example_results()
rci_targets <-results[Phenotype=="Recurrent Neisserial infections" & q<=0.05] 
p2g <- HPOExplorer::load_phenotype_to_genes()
data.table::setnames(p2g,"ID","HPO_ID")

rci_targets <- data.table::merge.data.table(rci_targets,
                                            p2g[,c("HPO_ID","Gene")],
                                            by="HPO_ID")
MultiEWCE::create_dt(rci_targets)
```

```{r}
rci_agg <- MultiEWCE::agg_results(rci_targets)
MultiEWCE::create_dt(rci_agg)
```



# Session info

<details>
```{r}
utils::sessionInfo()
```
</details>
<hr>